<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neurodivergent Self-Assessment</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  html { font-size: 18px; }

  :root {
    --bg: #0f1117;
    --surface: #181c27;
    --surface2: #1f2436;
    --border: #2a3050;
    --text: #e8eaf2;
    --text-dim: #b0b8d0;
    --text-dimmer: #7a83a0;
    --accent-a: #5b8ff9;
    --accent-u: #7ec8a0;
    --accent-o: #f0a070;
    --accent-au: #8b7fd4;
    --accent-uo: #6dbfb0;
    --accent-ao: #d4916e;
    --selected: #2a3a5c;
    --selected-border: #7aaaff;
    --radius: 10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    padding: 0 0 80px 0;
  }

  header {
    padding: 48px 24px 32px;
    max-width: 760px;
    margin: 0 auto;
    border-bottom: 1px solid var(--border);
    margin-bottom: 40px;
  }

  header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(1.8rem, 4vw, 2.6rem);
    font-weight: 400;
    color: var(--text);
    line-height: 1.2;
    margin-bottom: 14px;
  }

  header p {
    color: var(--text-dim);
    font-size: 0.95rem;
    line-height: 1.7;
    max-width: 560px;
  }

  .progress-wrap {
    max-width: 760px;
    margin: 0 auto 36px;
    padding: 0 24px;
  }

  .progress-bar-bg {
    height: 3px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-a), var(--accent-u));
    border-radius: 3px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .progress-label {
    font-size: 0.78rem;
    color: var(--text-dimmer);
    margin-top: 8px;
    letter-spacing: 0.04em;
  }

  .section-heading {
    max-width: 760px;
    margin: 48px auto 20px;
    padding: 0 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-heading h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.05rem;
    font-weight: 400;
    color: var(--text-dim);
    letter-spacing: 0.02em;
  }

  .section-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .question-card {
    max-width: 760px;
    margin: 0 auto 16px;
    padding: 0 24px;
  }

  .question-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px 24px 20px;
    transition: border-color 0.2s;
  }

  .question-inner.answered {
    border-color: var(--border);
    background: var(--surface2);
  }

  .question-text {
    font-size: 0.97rem;
    line-height: 1.65;
    color: var(--text);
    margin-bottom: 18px;
    font-weight: 400;
  }

  .q-num {
    color: var(--text-dimmer);
    font-size: 0.78rem;
    font-weight: 500;
    display: block;
    margin-bottom: 6px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .opt-btn {
    flex: 1;
    min-width: 80px;
    padding: 9px 6px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    white-space: nowrap;
  }

  .opt-btn:hover {
    border-color: var(--text-dimmer);
    color: var(--text);
    background: var(--surface2);
  }

  .opt-btn.selected {
    background: var(--selected);
    border-color: var(--selected-border);
    color: var(--text);
    font-weight: 500;
  }

  .opt-btn.locked {
    cursor: default;
    opacity: 0.7;
  }

  .opt-btn.locked:hover {
    border-color: var(--border);
    color: var(--text-dim);
    background: transparent;
  }

  .opt-btn.locked.selected {
    opacity: 1;
    cursor: default;
  }

  .opt-btn.locked.selected:hover {
    background: var(--selected);
    border-color: var(--selected-border);
    color: var(--text);
  }

  #results {
    display: none;
    max-width: 760px;
    margin: 48px auto 0;
    padding: 0 24px;
  }

  #results.visible { display: block; }

  .results-header {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 8px;
  }

  .results-sub {
    color: var(--text-dim);
    font-size: 0.88rem;
    margin-bottom: 32px;
    line-height: 1.6;
  }

  .score-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .score-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px 20px;
    text-align: center;
  }

  .score-label {
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dimmer);
    margin-bottom: 6px;
  }

  .score-name {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 16px;
  }

  .score-value {
    font-family: 'DM Serif Display', serif;
    font-size: 3rem;
    line-height: 1;
    margin-bottom: 4px;
  }

  .score-card.adhd .score-value { color: var(--accent-a); }
  .score-card.autism .score-value { color: var(--accent-u); }
  .score-card.ocd .score-value { color: var(--accent-o); }

  .score-band {
    font-size: 0.78rem;
    color: var(--text-dimmer);
  }

  .score-bar-wrap {
    margin-top: 12px;
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .score-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease;
    width: 0%;
  }

  .score-card.adhd .score-bar-fill { background: var(--accent-a); }
  .score-card.autism .score-bar-fill { background: var(--accent-u); }
  .score-card.ocd .score-bar-fill { background: var(--accent-o); }

  .export-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
  }

  .export-section h3 {
    font-family: 'DM Serif Display', serif;
    font-weight: 400;
    font-size: 1.1rem;
    margin-bottom: 6px;
  }

  .export-section p {
    color: var(--text-dim);
    font-size: 0.85rem;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .interp-body {
    color: var(--text-dim);
    font-size: 0.88rem;
    line-height: 1.75;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.83rem;
  }

  th {
    text-align: left;
    padding: 8px 12px;
    color: var(--text-dimmer);
    font-weight: 500;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text-dim);
    vertical-align: top;
  }

  tr:last-child td { border-bottom: none; }

  td.q-col { color: var(--text-dimmer); font-size: 0.75rem; width: 38px; }
  td.raw-col { text-align: center; width: 60px; }
  td.trans-col { text-align: center; width: 70px; color: var(--text); font-weight: 500; }
  td.tag-col { width: 60px; }

  .tag-pill {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.04em;
  }

  .tag-a { background: rgba(91,143,249,0.15); color: var(--accent-a); }
  .tag-u { background: rgba(126,200,160,0.15); color: var(--accent-u); }
  .tag-o { background: rgba(240,160,112,0.15); color: var(--accent-o); }
  .tag-au { background: rgba(139,127,212,0.15); color: var(--accent-au); }
  .tag-uo { background: rgba(109,191,176,0.15); color: var(--accent-uo); }
  .tag-ao { background: rgba(212,145,110,0.15); color: var(--accent-ao); }

  .btn-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .btn {
    padding: 11px 22px;
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    border: none;
  }

  .btn-primary {
    background: var(--accent-a);
    color: #fff;
  }

  .btn-primary:hover { opacity: 0.85; }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .btn-secondary:hover {
    border-color: var(--text-dimmer);
    color: var(--text);
  }

  .submit-bar {
    max-width: 760px;
    margin: 32px auto 0;
    padding: 0 24px;
  }

  .submit-bar p {
    font-size: 0.82rem;
    color: var(--text-dimmer);
    margin-top: 10px;
  }

  .warning {
    background: rgba(240,160,112,0.1);
    border: 1px solid rgba(240,160,112,0.3);
    border-radius: 7px;
    padding: 12px 16px;
    font-size: 0.85rem;
    color: var(--accent-o);
    margin-top: 12px;
    display: none;
  }

  .warning.visible { display: block; }

  .question-inner.highlight {
    border-color: var(--accent-o);
    transition: border-color 0.3s;
  }

  @media (max-width: 500px) {
    .score-grid { grid-template-columns: 1fr; }
    .opt-btn { min-width: 60px; font-size: 0.82rem; padding: 8px 4px; }
  }
</style>
</head>
<body>

<header>
  <h1>Neurodivergent Self-Assessment</h1>
  <p>Answer each question honestly based on your general experience across your life, not just recently. Choose the response that reflects how you actually experience things, not how you have learned to appear — this is especially important if you tend to mask or compensate, whether consciously or not. There are no right or wrong answers. Your scores are calculated privately in your browser — nothing is sent anywhere.</p>
  <p style="margin-top:10px;color:var(--text-dimmer);font-size:0.8rem;">This is an exploratory self-reflection tool, not a validated clinical instrument. It is designed to help you notice patterns and find language for your experience — not to provide a diagnosis. If you have developed strong strategies for managing or masking difficulties — something particularly common in women, people socialised as female, and anyone diagnosed late or not at all — your scores may underestimate the presence of underlying traits. A low score does not mean these patterns are absent from your experience. If completing this questionnaire brings up intense distress or feels overwhelming, please step away and speak to someone you trust or contact a mental health support line before continuing.</p>
</header>

<div class="progress-wrap">
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>
  <div class="progress-label" id="progressLabel">0 of 67 answered</div>
</div>

<div id="questionnaire"></div>

<div class="submit-bar">
  <button class="btn btn-primary" id="submitBtn" onclick="submitAssessment()">Calculate my scores</button>
  <div class="warning" id="warning"></div>
</div>

<div id="results">
  <div class="results-header">Your results</div>
  <p class="results-sub">These scores reflect patterns across your responses. They are not a diagnosis — they are a map of where your experience clusters, and a starting point for understanding yourself more clearly. All three scores use the same 0–100 scale and can be compared directly. When interpreting these results, consider not just whether you recognise the patterns described, but whether they cause meaningful difficulty in your relationships, work, self-care, or daily functioning. Traits without impairment are part of normal human variation.</p>
  <p class="results-sub" id="partialNote" style="display:none;color:var(--accent-o);"></p>

  <div class="score-grid">
    <div class="score-card adhd">
      <div class="score-label">A</div>
      <div class="score-name">ADHD pattern</div>
      <div class="score-value" id="scoreA">—</div>
      <div class="score-band" id="bandA"></div>
      <div class="score-bar-wrap"><div class="score-bar-fill" id="barA"></div></div>
    </div>
    <div class="score-card autism">
      <div class="score-label">U</div>
      <div class="score-name">Autism pattern</div>
      <div class="score-value" id="scoreU">—</div>
      <div class="score-band" id="bandU"></div>
      <div class="score-bar-wrap"><div class="score-bar-fill" id="barU"></div></div>
    </div>
    <div class="score-card ocd">
      <div class="score-label">O</div>
      <div class="score-name">OCD pattern</div>
      <div class="score-value" id="scoreO">—</div>
      <div class="score-band" id="bandO"></div>
      <div class="score-bar-wrap"><div class="score-bar-fill" id="barO"></div></div>
    </div>
  </div>

  <div class="export-section" id="interpretationBox" style="display:none;">
    <h3>What this means</h3>
    <div id="interpretationText" class="interp-body"></div>
  </div>

  <div class="export-section">
    <h3>Detailed breakdown</h3>
    <p>Every question, your raw answer, and its transformed score. All inversions and peak-transformations have already been applied. You can copy this table directly into a spreadsheet — the numbers are already normalised and comparable.</p>
    <p style="font-size:0.8rem;margin-bottom:16px;margin-top:-8px;">
      <span class="tag-pill tag-a">A</span> ADHD &nbsp;&nbsp;
      <span class="tag-pill tag-u">U</span> Autism &nbsp;&nbsp;
      <span class="tag-pill tag-o">O</span> OCD &nbsp;&nbsp;
      <span style="color:var(--text-dimmer);font-size:0.78rem;">Dual tags mean the item contributes to both subscales.</span>
    </p>
    <table>
      <thead>
        <tr>
          <th>Q</th>
          <th>Question (abbreviated)</th>
          <th>Tag</th>
          <th style="text-align:center">Raw</th>
          <th style="text-align:center">Score</th>
        </tr>
      </thead>
      <tbody id="detailTable"></tbody>
    </table>
  </div>

  <div class="export-section">
    <h3>Copy to spreadsheet</h3>
    <p>This gives you a single row of tab-separated values. Paste it into your spreadsheet to build up a comparison across sessions or people. Each row is: Date, A score, U score, O score, then all 67 transformed item scores. You may also find it useful to ask someone who knows you well — a partner, close friend, or family member — to complete this questionnaire about you independently and compare the two rows. Research consistently shows that self-report and informant perspectives differ, and the gap between them is itself informative.</p>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="copyToClipboard()">Copy row to clipboard</button>
      <button class="btn btn-secondary" onclick="resetAssessment()">Start again</button>
    </div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────────────────────────
// ITEM DEFINITIONS
// tags: array of subscales this item contributes to
// type: 'regular' (signal=high), 'reversed' (signal=low),
//       'peak' (signal=middle, symmetrical),
//       'peak_high' (signal=middle-to-high, asymmetric: high end scores more than low end)
// short: abbreviated text for the results table
// ─────────────────────────────────────────────────────────────────

const SECTIONS = [
  { title: "Attention & Focus", start: 0 },
  { title: "Impulsivity & Control", start: 9 },
  { title: "Activity & Energy Regulation", start: 15 },
  { title: "Executive Function", start: 19 },
  { title: "Social Interaction", start: 26 },
  { title: "Emotional Regulation", start: 32 },
  { title: "Repetitive & Restricted Patterns", start: 39 },
  { title: "Sensory Processing", start: 44 },
  { title: "Cognitive Style", start: 48 },
  { title: "Anxiety & Fear", start: 55 },
  { title: "Developmental Course & Coping", start: 61 },
];

function normalisedTagClass(tags) {
  const order = ['A','U','O'];
  const sorted = [...tags].sort((a,b) => order.indexOf(a) - order.indexOf(b));
  return 'tag-' + sorted.join('').toLowerCase();
}

const ITEMS = [
  // ── Attention & Focus (0-7) ──
  { q: "When you finish a routine task, how often do you find it was completed without any errors?", tags:["A"], type:"reversed", short:"Routine task completed error-free" },
  { q: "How often do you work through a task from start to finish without losing your thread of concentration?", tags:["A"], type:"reversed", short:"Task completed without losing concentration" },
  { q: "When engaged with something you find genuinely interesting, how often do hours pass without you registering the time?", tags:["A","U"], type:"regular", short:"Hours pass unnoticed when interested" },
  { q: "How often do you find yourself equally drawn to a wide range of topics rather than returning repeatedly to a few specific ones?", tags:["U"], type:"reversed", short:"Equally drawn to wide range of topics" },
  { q: "How often do particular worries or concerns keep pulling at your attention even when you are trying to focus on something else?", tags:["O"], type:"regular", short:"Worries pulling attention from focus" },
  { q: "When working somewhere with background noise or movement, how often does it fail to pull your attention away?", tags:["A"], type:"reversed", short:"Background noise doesn't pull attention" },
  { q: "Once focused on something, how often does shifting to a completely different task feel easy and natural?", tags:["U"], type:"reversed", short:"Shifting tasks feels easy" },
  { q: "How often do particular thoughts return to your mind repeatedly, even when you would rather move on from them?", tags:["O"], type:"regular", short:"Thoughts returning repeatedly" },
  // NEW: Hyperfocus disengagement (ADHD-specific, distinguishes from autistic deep interest)
  { q: "When you are deeply absorbed in something, how often do you find it difficult to stop even when you are aware that something more important needs your attention?", tags:["A"], type:"regular", short:"Difficulty stopping absorption despite knowing priorities" },
  { q: "How often do you commit to a course of action and only afterwards think through what the consequences might be?", tags:["A"], type:"regular", short:"Acting before thinking through consequences" },
  { q: "Before committing to something, how often do you naturally pause to think it through first?", tags:["A"], type:"reversed", short:"Naturally pausing before committing" },
  { q: "How often do you feel you need to carry out a particular action before you can feel settled or calm?", tags:["O"], type:"regular", short:"Needing action to feel settled" },
  // CHANGED: peak → peak_high. "Very often" mental replaying is high OCD signal, not low.
  { q: "How often do you find yourself mentally replaying or reviewing something — counting, checking, going over it again — in order to feel reassured?", tags:["O"], type:"peak_high", short:"Mental replaying to feel reassured" },
  { q: "Once you have started a habitual behaviour or sequence, how often does stopping partway through feel straightforward?", tags:["U","O"], type:"reversed", short:"Stopping habitual behaviour feels easy" },
  // NEW: Reward sensitivity / delay aversion (Sonuga-Barke dual pathway, Barkley motivational deficit)
  { q: "How often do you find yourself choosing something immediately available over something better that would require waiting?", tags:["A"], type:"regular", short:"Choosing immediate reward over delayed better option" },
  { q: "How often do you notice an urge to be moving or doing something, even in situations where sitting still is expected?", tags:["A"], type:"regular", short:"Urge to move when sitting still expected" },
  { q: "Even when sitting quietly, how often is there an underlying feeling of being internally switched on or agitated?", tags:["A","O"], type:"regular", short:"Internal agitation when sitting quietly" },
  { q: "How often do you find yourself tapping, shifting, bouncing your leg, or fidgeting during sedentary activities?", tags:["A","U"], type:"regular", short:"Fidgeting during sedentary activities" },
  { q: "How often do you engage in rhythmic or repetitive physical movements — such as rocking or particular hand movements — especially when excited or under pressure?", tags:["U"], type:"peak", short:"Rhythmic/repetitive movements when stressed or excited" },

  // ── Executive Function (17-22) ──
  { q: "How often do you find it easy to begin a task promptly, even one you know is important but not enjoyable?", tags:["A"], type:"reversed", short:"Easy to begin unenjoyable important tasks" },
  { q: "How often do you look up and find that a lot more time has passed than you were expecting?", tags:["A"], type:"regular", short:"More time passed than expected" },
  { q: "While completing a multi-step task, how often do you find it easy to hold the earlier steps in mind as you work through later ones?", tags:["A"], type:"reversed", short:"Holding earlier steps in mind easily" },
  { q: "When a situation calls for a different approach than your usual one, how often does adapting feel comfortable?", tags:["U","O"], type:"reversed", short:"Adapting to different approach feels comfortable" },
  { q: "How often do you move between different tasks during a day without any noticeable friction or effort?", tags:["U","A"], type:"reversed", short:"Moving between tasks without friction" },
  { q: "How often does wanting to get something exactly right prevent you from starting it, or from calling it finished?", tags:["O","U"], type:"peak", short:"Perfectionism preventing starting or finishing" },
  // NEW: Working memory impairment (explicit, beyond task-completion framing of Q20)
  { q: "How often do you find that information you were holding in mind — a number, a name, what you went into a room to get — has simply vanished by the time you need it?", tags:["A"], type:"regular", short:"Information held in mind vanishing before use" },
  { q: "In conversation, how often do you find a natural moment to stop talking and give the other person extended space to respond?", tags:["A"], type:"reversed", short:"Finding natural moment to stop talking" },
  { q: "How often do you pick up on unspoken signals — tone, posture, expression — without consciously having to think about it?", tags:["U"], type:"reversed", short:"Picking up unspoken signals automatically" },
  { q: "When someone is being indirect or ironic, how often does the intended meaning come to you immediately?", tags:["U"], type:"reversed", short:"Indirect/ironic meaning comes immediately" },
  { q: "How often do social situations leave you feeling drained in a way that goes beyond ordinary tiredness?", tags:["U","O"], type:"peak", short:"Social situations leaving you drained" },
  { q: "When discussing something you find fascinating, how often do you notice the other person's interest beginning to drift and adjust accordingly?", tags:["U"], type:"reversed", short:"Noticing and adjusting to others' drifting interest" },
  { q: "How often do you say something in conversation and only realise a moment later that it came across differently than you intended?", tags:["A"], type:"peak", short:"Saying something that lands differently than intended" },

  // ── Emotional Regulation (29-33) ──
  { q: "How often do your emotional responses escalate more quickly or intensely than the situation seems to call for?", tags:["A"], type:"peak", short:"Emotions escalating beyond situation" },
  { q: "How often does a critical comment or perceived rejection leave a strong and lasting impression on you emotionally?", tags:["A"], type:"regular", short:"Critical comment leaving strong impression" },
  // NEW: RSD anticipatory avoidance
  { q: "How often do you avoid putting yourself forward — for opportunities, in conversations, or in relationships — because the possibility of being turned down or judged feels too difficult to risk?", tags:["A"], type:"regular", short:"Avoiding opportunities due to fear of rejection" },
  // NEW: RSD rejection misperception
  { q: "How often do you interpret a neutral or ambiguous signal from someone — a delayed reply, a change of tone, a cancelled plan — as a sign that they are upset with you or have lost interest in you?", tags:["A"], type:"regular", short:"Interpreting neutral signals as rejection" },
  { q: "How often does an accumulation of demands reach a point where you feel unable to continue and need to withdraw?", tags:["U"], type:"peak", short:"Demands accumulating to point of withdrawal" },
  { q: "How often does an unexpected change to your plans or usual routine cause you noticeable distress?", tags:["U","O"], type:"regular", short:"Unexpected change causing noticeable distress" },
  { q: "How often does your mood shift noticeably across the course of a single day in response to things happening around you?", tags:["A"], type:"regular", short:"Mood shifting noticeably across the day" },

  // ── Repetitive & Restricted Patterns (34-38) ──
  { q: "How often do you find yourself returning to the same small set of topics or activities for the majority of your focused attention?", tags:["U"], type:"regular", short:"Returning to same small set of topics" },
  { q: "How often is having a predictable structure or routine to your day genuinely important to your sense of wellbeing?", tags:["U","O"], type:"regular", short:"Predictable routine important to wellbeing" },
  { q: "How often can you discard or give away possessions without any particular worry about what might happen as a result?", tags:["O"], type:"reversed", short:"Discarding possessions without worry" },
  { q: "How often do you seek reassurance from others — asking 'are you sure?' or similar — in order to settle a feeling of doubt?", tags:["O"], type:"regular", short:"Seeking reassurance to settle doubt" },
  { q: "How often do you return to familiar media — rewatching, rereading, replaying — specifically because knowing what will happen feels comforting?", tags:["U","A"], type:"regular", short:"Returning to familiar media for comfort" },

  // ── Sensory Processing (39-42) ──
  { q: "How often do sensory experiences — sounds, light levels, textures, or smells — affect you more strongly than they appear to affect those around you?", tags:["U"], type:"regular", short:"Sensory experiences affecting you more strongly" },
  { q: "How often do you actively seek out intense sensory input — pressure, movement, strong flavours — because you find it settling or satisfying?", tags:["A","U"], type:"peak", short:"Seeking intense sensory input" },
  { q: "How often do specific textures, fabrics, or food consistencies produce a physical discomfort strong enough to influence your choices?", tags:["U"], type:"regular", short:"Textures causing discomfort influencing choices" },
  { q: "How often does a particular sensory experience reliably trigger a feeling of unease or heightened anxiety?", tags:["U","O"], type:"peak", short:"Sensory experience triggering unease" },

  // ── Cognitive Style (43-49) ──
  { q: "How often does your thinking jump rapidly between different ideas or connections within a short space of time?", tags:["A"], type:"regular", short:"Thinking jumping between ideas rapidly" },
  { q: "How often do you notice small inconsistencies or patterns in information that other people around you appear to have overlooked?", tags:["U","O"], type:"regular", short:"Noticing inconsistencies others overlook" },
  { q: "How often does your thinking settle into clear opposing categories — something either works or it doesn't — rather than feeling comfortable with ambiguity?", tags:["U","O"], type:"regular", short:"Thinking in clear opposing categories" },
  { q: "How often, when considering a future situation, does your mind move towards imagining the worst likely outcome?", tags:["O"], type:"regular", short:"Mind moving to worst-case outcomes" },
  { q: "How often does your mind return to a past event or conversation, even when you would prefer to move on from it?", tags:["O","A"], type:"regular", short:"Mind returning to past events" },
  { q: "How often do you notice underlying structures, patterns, or connections in things that others around you don't appear to be seeing?", tags:["U"], type:"regular", short:"Noticing patterns others don't see" },
  // CHANGED: peak → peak_high. Extreme moral distress is high OCD signal.
  { q: "How often does concern about your own moral conduct cause you noticeable distress or prompt you to examine your own behaviour?", tags:["O"], type:"peak_high", short:"Moral concern causing distress" },

  // ── Anxiety & Fear (50-55) ──
  // CHANGED: peak → peak_high. Extreme contamination concern is high OCD signal.
  { q: "How often do concerns about dirt, germs, or contamination influence your behaviour or cause you noticeable unease?", tags:["O"], type:"peak_high", short:"Contamination concerns influencing behaviour" },
  // CHANGED: peak → peak_high. Frequent intrusive harm thoughts are high OCD signal.
  { q: "How often do thoughts about accidentally causing harm to someone arise in a way that feels distressing?", tags:["O"], type:"peak_high", short:"Distressing thoughts about causing harm" },
  { q: "How often do you check something — a lock, a message, a piece of work — more than once because of a lingering feeling that something might be wrong?", tags:["O"], type:"regular", short:"Checking things more than once" },
  // CHANGED: peak → peak_high. Frequent ego-dystonic intrusive thoughts are high OCD signal.
  { q: "How often do thoughts that feel disturbing or out of character enter your mind without invitation?", tags:["O"], type:"peak_high", short:"Disturbing thoughts entering uninvited" },
  { q: "How often do difficulties with staying organised or following through produce a background sense of anxiety in your day-to-day life?", tags:["A"], type:"regular", short:"Organisation difficulties producing background anxiety" },
  { q: "How often does unpredictability — a change of plan, an unclear expectation, a sudden event — reliably produce anxiety for you?", tags:["U","O"], type:"regular", short:"Unpredictability producing anxiety" },

  // ── Developmental Course & Coping (56-59) ──
  { q: "Looking back at childhood, how often do you recall attention, energy level, or self-control being a noticeable issue before the age of twelve?", tags:["A"], type:"regular", short:"Childhood attention/energy/self-control issues" },
  { q: "Reflecting on early childhood, how often do you recall your communication or social connection with others feeling different from that of your peers?", tags:["U"], type:"peak", short:"Childhood social connection feeling different" },
  { q: "How often do the difficulties you experience become noticeably more prominent during periods of high stress or demand?", tags:["A","O"], type:"regular", short:"Difficulties more prominent under stress" },
  { q: "How often, after carrying out a repeated behaviour or ritual, do you feel temporary relief — even though the underlying feeling tends to return?", tags:["O"], type:"regular", short:"Temporary relief from repeated behaviour" },
  // NEW ITEM: camouflaging/masking probe (addresses Lai & Mandy critique)
  { q: "How often do you consciously monitor, rehearse, or adjust your behaviour in social situations in order to come across the way others seem to expect?", tags:["U","A"], type:"regular", short:"Consciously monitoring/adjusting social behaviour" },
  // NEW ITEM: effort-outcome gap / functional impairment probe (addresses Barkley critique)
  { q: "How often do you feel that the effort you put into managing everyday life is significantly greater than what others around you seem to need for similar results?", tags:["A","U"], type:"regular", short:"Effort for daily life exceeds what others seem to need" },
  // REMOVED: "variation in social style / sensory sensitivities over life" (reversed U item).
  // Replaced by two items above which address expert critiques more directly.
];

// CHANGED: anchor labels to reduce endpoint aversion (STAI-based approach)
const LABELS = ["Almost never", "Rarely", "Sometimes", "Often", "Almost always"];
const responses = new Array(ITEMS.length).fill(null);
let isLocked = false; // Prevents answer changes after submission

// ─────────────────────────────────────────────────────────────────
// TRANSFORMATION ENGINE
// ─────────────────────────────────────────────────────────────────
// regular:   1→0, 2→1, 3→2, 4→3, 5→4  (high = signal)
// reversed:  1→4, 2→3, 3→2, 4→1, 5→0  (low = signal)
// peak:      3→4, 2/4→2, 1/5→0         (middle = signal, symmetric)
// peak_high: 3→4, 4→3, 2→2, 5→1, 1→0  (middle-to-high = signal, asymmetric)
//   This preserves the peak shape but treats high-end answers as more
//   informative than low-end, fixing the OCD intrusive thought problem.

function transform(raw, type) {
  if (type === 'regular')    return raw - 1;
  if (type === 'reversed')   return 5 - raw;
  if (type === 'peak')       return 4 - 2 * Math.abs(raw - 3);
  if (type === 'peak_high') {
    // Asymmetric peak: centre=4, one-above=3, one-below=2, high-extreme=1, low-extreme=0
    const map = [0, 0, 2, 4, 3, 1];
    return map[raw];
  }
  return 0;
}

// Pre-calculate fixed max per subscale.
// peak_high items have max score of 4 (same as all other types).
const MAX_SCORES = (() => {
  const counts = { A: 0, U: 0, O: 0 };
  ITEMS.forEach(item => {
    item.tags.forEach(tag => counts[tag]++);
  });
  return { A: counts.A * 4, U: counts.U * 4, O: counts.O * 4 };
})();

function calcScores() {
  const sums = { A: 0, U: 0, O: 0 };
  const answeredCounts = { A: 0, U: 0, O: 0 };

  ITEMS.forEach((item, i) => {
    const raw = responses[i];
    if (raw === null) return;
    const t = transform(raw, item.type);
    item.tags.forEach(tag => {
      sums[tag] += t;
      answeredCounts[tag]++;
    });
  });

  const scores = {};
  ['A','U','O'].forEach(tag => {
    const maxForAnswered = answeredCounts[tag] * 4;
    scores[tag] = maxForAnswered > 0 ? Math.round((sums[tag] / maxForAnswered) * 100) : 0;
  });
  scores._answeredCounts = answeredCounts;
  return scores;
}

// CHANGED: Aligned band labels with interpretation thresholds.
// Interpretation uses MODERATE=40, STRONG=65. Bands now match.
function getBand(score) {
  if (score < 25)  return "Not strongly present";
  if (score < 40)  return "Mild or subclinical";
  if (score < 65)  return "Moderate — worth exploring";
  return "Strong signal";
}

// ─────────────────────────────────────────────────────────────────
// RENDER
// ─────────────────────────────────────────────────────────────────
function renderSections() {
  const container = document.getElementById('questionnaire');
  container.innerHTML = '';

  SECTIONS.forEach((section, si) => {
    const nextStart = si < SECTIONS.length - 1 ? SECTIONS[si + 1].start : ITEMS.length;

    const sh = document.createElement('div');
    sh.className = 'section-heading';
    sh.innerHTML = `<h2>${section.title}</h2><div class="section-line"></div>`;
    container.appendChild(sh);

    for (let i = section.start; i < nextStart; i++) {
      const item = ITEMS[i];
      const card = document.createElement('div');
      card.className = 'question-card';
      card.id = `qcard-${i}`;

      const inner = document.createElement('div');
      inner.className = 'question-inner' + (responses[i] !== null ? ' answered' : '');
      inner.id = `qinner-${i}`;

      const qnum = document.createElement('span');
      qnum.className = 'q-num';
      qnum.textContent = `Q${i + 1}`;

      const qtext = document.createElement('div');
      qtext.className = 'question-text';
      qtext.textContent = item.q;

      const opts = document.createElement('div');
      opts.className = 'options';

      LABELS.forEach((label, val) => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn' + (responses[i] === val + 1 ? ' selected' : '');
        if (isLocked) btn.classList.add('locked');
        btn.textContent = label;
        btn.onclick = () => { if (!isLocked) selectResponse(i, val + 1); };
        opts.appendChild(btn);
      });

      inner.appendChild(qnum);
      inner.appendChild(qtext);
      inner.appendChild(opts);
      card.appendChild(inner);
      container.appendChild(card);
    }
  });

  updateProgress();
}

function selectResponse(qIdx, val) {
  if (isLocked) return;
  responses[qIdx] = val;

  const inner = document.getElementById(`qinner-${qIdx}`);
  if (inner) {
    inner.classList.add('answered');
    inner.classList.remove('highlight');
    const btns = inner.querySelectorAll('.opt-btn');
    btns.forEach((btn, i) => {
      btn.classList.toggle('selected', i === val - 1);
    });
  }

  updateProgress();
}

function updateProgress() {
  const answered = responses.filter(r => r !== null).length;
  const total = ITEMS.length;
  const pct = Math.round((answered / total) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = `${answered} of ${total} answered`;
}

// ─────────────────────────────────────────────────────────────────
// INTERPRETATION
// ─────────────────────────────────────────────────────────────────
function generateInterpretation(scores) {
  const { A, U, O } = scores;
  const STRONG = 65, MODERATE = 40;

  const strongProfiles = [];
  if (A >= STRONG) strongProfiles.push('ADHD');
  if (U >= STRONG) strongProfiles.push('autism');
  if (O >= STRONG) strongProfiles.push('OCD');

  const moderateProfiles = [];
  if (A >= MODERATE && A < STRONG) moderateProfiles.push('ADHD');
  if (U >= MODERATE && U < STRONG) moderateProfiles.push('autism');
  if (O >= MODERATE && O < STRONG) moderateProfiles.push('OCD');

  let para1 = '';
  let para2 = '';
  let para3 = '';

  // ── Opening: what the pattern looks like ──
  if (strongProfiles.length === 0 && moderateProfiles.length === 0) {
    para1 = 'Your responses do not show a pronounced pattern aligned with ADHD, autism, or OCD traits. This could mean these profiles are genuinely not a major feature of your experience, or that your traits are more evenly distributed or situational. It is also worth knowing that depression, anxiety, trauma, and chronic stress can produce experiences — difficulty concentrating, emotional dysregulation, social withdrawal, repetitive thinking — that closely resemble these profiles without being them. Equally, a low score does not rule out an underlying condition if you have developed strong compensatory or masking strategies over your lifetime. This is particularly common in women, people socialised as female, those diagnosed late, and anyone who has spent years adapting to environments that required them to appear typical. If something still feels persistently difficult or different, that is worth exploring with a professional, even if this questionnaire did not produce a strong signal.';
  } else if (strongProfiles.length === 1 && moderateProfiles.length === 0) {
    // CHANGED: Profile-specific language instead of generic "depending on which profile"
    let profileDetail = '';
    if (strongProfiles[0] === 'ADHD') {
      profileDetail = 'The experiences described across the questionnaire — particularly around sustained attention, impulse regulation, task initiation, time perception, and emotional reactivity — cluster meaningfully in this direction.';
    } else if (strongProfiles[0] === 'autism') {
      profileDetail = 'The experiences described across the questionnaire — particularly around social processing, sensory sensitivity, preference for routine, and focused interests — cluster meaningfully in this direction.';
    } else {
      profileDetail = 'The experiences described across the questionnaire — particularly around intrusive thoughts, checking and reassurance-seeking, anxiety about uncertainty, and difficulty disengaging from mental loops — cluster meaningfully in this direction.';
    }
    para1 = `Your responses show a pronounced pattern of traits consistent with ${strongProfiles[0]}. ${profileDetail} This is not a diagnosis. Clinicians arrive at diagnoses by integrating self-report with developmental history, direct observation, and an assessment of how traits affect daily functioning — none of which a questionnaire can replicate. What this does give you is a coherent starting point.`;
  } else if (strongProfiles.length >= 2) {
    para1 = `Your responses show pronounced patterns consistent with more than one profile — specifically ${strongProfiles.join(' and ')}. This is more common than many people realise: ADHD and autism co-occur in roughly 50–70% of cases, and OCD overlaps significantly with both. Rather than meaning your results are unclear, this likely reflects that your experience is genuinely complex, and that a single-label explanation would be an oversimplification. As with any self-report tool, a formal assessment would integrate this picture with your history, observed behaviour, and functional impact before any conclusions are drawn.`;
  } else {
    const all = [...strongProfiles, ...moderateProfiles];
    para1 = `Your responses show a moderate pattern across ${all.join(' and ')} traits. The signal is present but not pronounced — which can reflect genuine mild traits, a mixed picture, or simply high variability in how these traits express themselves day to day.`;
  }

  // ── Middle: the overlap explanation ──
  const hasOverlap = (A >= MODERATE && O >= MODERATE) || (U >= MODERATE && O >= MODERATE) || (A >= MODERATE && U >= MODERATE);
  if (hasOverlap) {
    if (U >= MODERATE && O >= MODERATE) {
      para2 = 'The overlap between your autism and OCD scores is worth noting specifically. Autistic people experience clinically significant OCD at roughly three to four times the rate of the general population, and the two can be difficult to distinguish because both involve repetitive behaviours, rigid thinking, and high anxiety. The difference in origin matters for treatment — OCD responds well to specific therapy approaches that are not always appropriate for autistic rigidity — so unpicking which is which, ideally with a clinician familiar with both, is genuinely useful.';
    } else if (A >= MODERATE && U >= MODERATE) {
      para2 = 'Your ADHD and autism scores are both elevated. This combination — sometimes called AuDHD — is now recognised as a distinct presentation rather than simply two separate conditions running in parallel. People with both often describe an internal experience that feels more contradictory and effortful than either label alone would suggest: the ADHD drive for novelty pulling against the autistic need for predictability, for instance, or the hyperactivity of ADHD masking the sensory sensitivities that are more obvious in autism. If this resonates, it is worth seeking assessment from someone specifically experienced with both.';
    } else if (A >= MODERATE && O >= MODERATE) {
      // CHANGED: Added softening qualifier about ego-syntonic/dystonic boundary
      para2 = 'Your ADHD and OCD scores are both notable. These two co-occur more than expected by chance, and share features like intrusive thoughts and difficulty regulating attention — though the mechanisms differ. ADHD intrusive thoughts tend to be ego-syntonic (they feel like part of you), while OCD intrusive thoughts are typically ego-dystonic (they feel alien and distressing). This distinction is not always clean-cut, particularly when both conditions are present, but as a general pattern it can help you reflect on which dynamic feels more familiar to your own experience.';
    }
  }

  // ── Close: what to do next ──
  if (strongProfiles.length > 0 || moderateProfiles.length > 0) {
    // CHANGED: Added base rate acknowledgement, functional impairment framing, and masking caveat
    para3 = 'A note on context: people who seek out a tool like this are already a non-random group. You are likely here because something in your experience prompted the question. That context matters when interpreting these scores — they may mean something different for someone actively investigating a pattern than they would for a person completing the questionnaire out of idle curiosity. As a next step, this score profile can be a useful thing to bring to a GP or mental health professional as a starting point for a conversation — not as evidence of a diagnosis, but as a structured description of patterns you have noticed in yourself. If you are not ready for that, or if access is difficult, many people find it helpful to read first-person accounts by people with the profiles that resonated most, and to see whether those accounts reflect their own inner experience. Self-knowledge itself has value, independent of any formal label. If at any point reflecting on these results feels distressing or overwhelming, please reach out to a trusted person or a mental health support line rather than sitting with it alone.';
  } else {
    para3 = 'If you feel the questionnaire did not quite capture your experience, it is worth trying again at a different time, or looking at more specific tools for any area that feels relevant. The questions here are broad by design, and some people\'s traits only become visible in more targeted assessments. It may also be worth considering whether strong coping strategies have developed over time that reduce the visible frequency of these experiences without removing the underlying effort they require.';
  }

  return [para1, para2, para3].filter(Boolean).map(p => `<p style="margin-bottom:14px;">${p}</p>`).join('');
}

// ─────────────────────────────────────────────────────────────────
// SUBMIT
// ─────────────────────────────────────────────────────────────────
function submitAssessment() {
  const answered = responses.filter(r => r !== null).length;
  const total = ITEMS.length;
  const MIN_ANSWERS = Math.ceil(total * 0.8); // 80% threshold (50 of 62)
  const unanswered = responses.map((r, i) => r === null ? i : -1).filter(i => i >= 0);
  const warningEl = document.getElementById('warning');

  if (answered < MIN_ANSWERS) {
    warningEl.textContent = `Please answer at least ${MIN_ANSWERS} of ${total} questions before submitting. You have answered ${answered} so far. Unanswered questions are highlighted above.`;
    warningEl.classList.add('visible');
    unanswered.forEach(i => {
      const inner = document.getElementById(`qinner-${i}`);
      if (inner) inner.classList.add('highlight');
    });
    const first = document.getElementById(`qcard-${unanswered[0]}`);
    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  warningEl.classList.remove('visible');

  // Lock answers after submission
  isLocked = true;
  document.querySelectorAll('.opt-btn').forEach(btn => {
    btn.classList.add('locked');
  });
  document.getElementById('submitBtn').style.display = 'none';

  const isPartial = answered < total;
  const scores = calcScores();

  ['A','U','O'].forEach(tag => {
    document.getElementById(`score${tag}`).textContent = scores[tag];
    document.getElementById(`band${tag}`).textContent = getBand(scores[tag]);
    setTimeout(() => {
      document.getElementById(`bar${tag}`).style.width = scores[tag] + '%';
    }, 100);
  });

  // Show partial completion note if applicable
  const partialNote = document.getElementById('partialNote');
  if (isPartial) {
    const answered = responses.filter(r => r !== null).length;
    partialNote.textContent = `These scores are based on ${answered} of ${ITEMS.length} questions. Scores are normalised to the items you answered, so they remain comparable, but may be less stable than a complete set. Unanswered items are marked below.`;
    partialNote.style.display = 'block';
  } else {
    partialNote.style.display = 'none';
  }

  const interpBox  = document.getElementById('interpretationBox');
  const interpText = document.getElementById('interpretationText');
  interpText.innerHTML = generateInterpretation(scores);
  interpBox.style.display = 'block';

  const tbody = document.getElementById('detailTable');
  tbody.innerHTML = '';

  ITEMS.forEach((item, i) => {
    const raw = responses[i];
    const t = raw !== null ? transform(raw, item.type) : null;
    const row = document.createElement('tr');
    if (raw === null) row.style.opacity = '0.45';

    const tagHTML = item.tags.map(tag => {
      if (item.tags.length === 1) {
        return `<span class="tag-pill tag-${tag.toLowerCase()}">${tag}</span>`;
      }
      return `<span class="tag-pill ${normalisedTagClass(item.tags)}">${tag}</span>`;
    }).join(' ');

    row.innerHTML = `
      <td class="q-col">Q${i+1}</td>
      <td>${item.short}</td>
      <td class="tag-col">${tagHTML}</td>
      <td class="raw-col">${raw !== null ? LABELS[raw-1] : '—'}</td>
      <td class="trans-col">${t !== null ? t : '—'}</td>
    `;
    tbody.appendChild(row);
  });

  const resultsEl = document.getElementById('results');
  resultsEl.classList.add('visible');
  setTimeout(() => {
    resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// ─────────────────────────────────────────────────────────────────
// EXPORT
// ─────────────────────────────────────────────────────────────────
function buildExportText() {
  // Uses the locked responses, so scores always match what was displayed.
  const scores = calcScores();
  const date = new Date().toLocaleDateString('en-GB');
  const transformedScores = ITEMS.map((item, i) => responses[i] !== null ? transform(responses[i], item.type) : '');
  const row  = [date, scores.A, scores.U, scores.O, ...transformedScores].join('\t');
  const header = ['Date','A_score','U_score','O_score',
    ...ITEMS.map((_,i) => `Q${i+1}`)].join('\t');
  return header + '\n' + row;
}

function showFallbackBox(text) {
  const existing = document.getElementById('fallbackBox');
  if (existing) existing.remove();

  const wrap = document.createElement('div');
  wrap.id = 'fallbackBox';
  wrap.style.cssText = 'margin-top:14px;';

  const msg = document.createElement('p');
  msg.textContent = 'Automatic copy is not available in this context. Select all the text below and copy it manually (Ctrl+A then Ctrl+C):';
  msg.style.cssText = 'font-size:0.85rem;color:var(--accent-o);margin-bottom:8px;';

  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'width:100%;height:80px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:10px;font-family:monospace;font-size:0.75rem;resize:vertical;';
  ta.addEventListener('focus', () => ta.select());

  wrap.appendChild(msg);
  wrap.appendChild(ta);

  const btn = document.querySelector('[onclick="copyToClipboard()"]');
  btn.parentNode.insertBefore(wrap, btn.nextSibling);
  ta.focus();
}

function copyToClipboard() {
  const text = buildExportText();
  const btn  = document.querySelector('[onclick="copyToClipboard()"]');

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      const orig = btn.textContent;
      btn.textContent = '\u2713 Copied!';
      btn.style.background = 'var(--accent-u)';
      setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2500);
    }).catch(() => {
      if (!execCommandCopy(text)) showFallbackBox(text);
    });
    return;
  }

  if (!execCommandCopy(text)) showFallbackBox(text);
}

function execCommandCopy(text) {
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0;';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if (ok) {
      const btn = document.querySelector('[onclick="copyToClipboard()"]');
      const orig = btn.textContent;
      btn.textContent = '\u2713 Copied!';
      btn.style.background = 'var(--accent-u)';
      setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2500);
    }
    return ok;
  } catch(e) {
    return false;
  }
}

function resetAssessment() {
  responses.fill(null);
  isLocked = false;
  document.getElementById('results').classList.remove('visible');
  document.getElementById('interpretationBox').style.display = 'none';
  document.getElementById('interpretationText').innerHTML = '';
  document.getElementById('submitBtn').style.display = '';
  renderSections();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ─────────────────────────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────────────────────────
renderSections();
</script>
</body>
</html>
